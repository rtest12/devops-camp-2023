worker_processes 1;
daemon off;

pid /tmp/nginx.pid;

events {
	worker_connections 768;
}

http {

	types_hash_max_size 4096;
	include mime.types;
	default_type application/octet-stream;
	error_log /dev/stderr;
	access_log /dev/stdout;

	upstream php-fpm-slow {
		server unix:/workspace/.php.fpm.d/php8.1-fpm-slow.sock fail_timeout=0;
	}

	upstream php-fpm {
		server unix:/workspace/.php.fpm.d/php8.1-fpm.sock;
	}

	server {
		server_name _;
		listen 80;
		fastcgi_temp_path      /tmp/nginx_fastcgi 1 2;
		client_body_temp_path  /tmp/nginx_client_body 1 2;
		proxy_temp_path        /tmp/nginx_proxy 1 2;
		fastcgi_param  QUERY_STRING       $query_string;
		fastcgi_param  REQUEST_METHOD     $request_method;
		fastcgi_param  CONTENT_TYPE       $content_type;
		fastcgi_param  CONTENT_LENGTH     $content_length;
		fastcgi_param  SCRIPT_NAME        $fastcgi_script_name;
		fastcgi_param  REQUEST_URI        $request_uri;
		fastcgi_param  DOCUMENT_URI       $document_uri;
		fastcgi_param  DOCUMENT_ROOT      $document_root;
		fastcgi_param  SERVER_PROTOCOL    $server_protocol;
		fastcgi_param  REQUEST_SCHEME     $scheme;
		fastcgi_param  HTTPS              $https if_not_empty;

		fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;
		fastcgi_param  SERVER_SOFTWARE    nginx/$nginx_version;

		fastcgi_param  REMOTE_ADDR        $remote_addr;
		fastcgi_param  REMOTE_PORT        $remote_port;
		fastcgi_param  REMOTE_USER        $remote_user;
		fastcgi_param  SERVER_ADDR        $server_addr;
		fastcgi_param  SERVER_PORT        $server_port;
		fastcgi_param  SERVER_NAME        $server_name;
		fastcgi_param  SCRIPT_FILENAME    $realpath_root$fastcgi_script_name;
		fastcgi_param  REDIRECT_STATUS    200;

		location / {
			fastcgi_split_path_info ^(.+\.php)(.*)$;
		}

		location ~^/reports/fast/ {
			root /workspace;
			try_files /fast.php =404;
			fastcgi_pass php-fpm;
			fastcgi_read_timeout 60;
		}

		location ~^/reports/slow/ {
			root /workspace;
			try_files /slow.php =404;
			fastcgi_pass php-fpm-slow;
			fastcgi_read_timeout 605;
		}
	}
}
